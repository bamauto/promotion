---
import BlogLayout from '../../layouts/BlogLayout.astro';
import PostContent from '../../components/PostContent.astro';
import RegionImage from '../../components/RegionImage.astro';
import RelatedPosts from '../../components/RelatedPosts.astro';
import { getPostBySlug, getRelatedPosts } from '../../lib/posts';
import { REGIONS, isValidRegion, getRegionDomain } from '../../lib/regions';
import type { RegionId } from '../../lib/regions';

// SSR: Dynamic routing with date-based filtering
const { region, slug } = Astro.params;

if (!region || !slug || !isValidRegion(region)) {
  return Astro.redirect('/');
}

const regionId = region as RegionId;
const post = await getPostBySlug(regionId, slug);

if (!post) {
  return Astro.redirect('/blog');
}

const regionData = REGIONS[regionId];
const relatedPosts = await getRelatedPosts(regionId, slug, post.category, 3);
const baseUrl = getRegionDomain(regionId);

const formattedDate = post.published_at
  ? new Date(post.published_at).toLocaleDateString('ko-KR', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    })
  : null;

const title = post.meta_title || `${post.title} | ${regionData.name} 블로그`;
const description = post.meta_description || post.excerpt || `${regionData.name} 지역 프로모션 정보`;

// BreadcrumbList schema
const breadcrumbSchema = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    {
      '@type': 'ListItem',
      position: 1,
      name: '홈',
      item: baseUrl,
    },
    {
      '@type': 'ListItem',
      position: 2,
      name: '블로그',
      item: `${baseUrl}/blog`,
    },
    {
      '@type': 'ListItem',
      position: 3,
      name: post.title,
      item: `${baseUrl}/blog/${slug}`,
    },
  ],
};
---

<BlogLayout
  title={title}
  description={description}
  region={regionId}
  canonicalPath={`/blog/${slug}`}
  ogImage={post.featuredImage?.url}
  ogImageWidth={post.featuredImage?.width || 1200}
  ogImageHeight={post.featuredImage?.height || 630}
  slug={slug}
  article={{
    publishedTime: post.published_at || undefined,
    modifiedTime: post.updated_at,
    author: post.author,
    tags: post.tags,
  }}
>
  <!-- BreadcrumbList Schema -->
  <script is:inline type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />

  <article class="post-container">
    <header class="post-header">
      <nav class="breadcrumb" aria-label="Breadcrumb">
        <ol itemscope itemtype="https://schema.org/BreadcrumbList">
          <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a href={`${baseUrl}/`} itemprop="item">
              <span itemprop="name">홈</span>
            </a>
            <meta itemprop="position" content="1" />
            <span aria-hidden="true">/</span>
          </li>
          <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a href="/blog" itemprop="item">
              <span itemprop="name">블로그</span>
            </a>
            <meta itemprop="position" content="2" />
            <span aria-hidden="true">/</span>
          </li>
          <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <span itemprop="name">{post.title}</span>
            <meta itemprop="position" content="3" />
          </li>
        </ol>
      </nav>

      {post.category && <span class="post-category">{post.category}</span>}

      <h1>{post.title}</h1>

      <div class="post-meta">
        {formattedDate && (
          <time datetime={post.published_at || ''}>
            {formattedDate}
          </time>
        )}
        {post.author && <span class="author">by {post.author}</span>}
      </div>

      {post.tags && post.tags.length > 0 && (
        <div class="post-tags">
          {post.tags.map((tag) => (
            <span class="tag">#{tag}</span>
          ))}
        </div>
      )}
    </header>

    {post.featuredImage && (
      <RegionImage
        src={post.featuredImage.url}
        alt={post.featuredImage.alt}
        width={post.featuredImage.width}
        height={post.featuredImage.height}
        loading="eager"
        class="featured"
      />
    )}

    <PostContent content={post.content} />

    <RelatedPosts posts={relatedPosts} region={regionId} />
  </article>
</BlogLayout>

<style>
  .post-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem 1.5rem 4rem;
  }

  .breadcrumb {
    margin-bottom: 1.5rem;
    font-size: 0.875rem;
  }

  .breadcrumb ol {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .breadcrumb li {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .breadcrumb a {
    color: #a0a0a0 !important;
    text-decoration: none !important;
  }

  .breadcrumb a:hover {
    color: #e94560 !important;
    text-decoration: none !important;
  }

  .breadcrumb li:last-child span {
    color: var(--color-text);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 200px;
  }

  .breadcrumb span[aria-hidden] {
    color: var(--color-text-muted);
  }

  .post-header {
    margin-bottom: 2rem;
  }

  .post-category {
    display: inline-block;
    background: var(--color-accent);
    color: white;
    padding: 0.3rem 1rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    margin-bottom: 1rem;
  }

  .post-header h1 {
    font-size: 2.5rem;
    font-weight: 800;
    line-height: 1.3;
    margin-bottom: 1rem;
    color: var(--color-text);
  }

  .post-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    color: var(--color-text-muted);
    font-size: 0.9rem;
    margin-bottom: 1rem;
  }

  .post-meta time::before {
    content: '';
  }

  .post-meta .author::before {
    content: '';
  }

  .post-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .tag {
    background: var(--color-secondary);
    color: var(--color-text-muted);
    padding: 0.25rem 0.75rem;
    border-radius: 4px;
    font-size: 0.8rem;
  }

  @media (max-width: 640px) {
    .post-header h1 {
      font-size: 1.75rem;
    }
  }
</style>
